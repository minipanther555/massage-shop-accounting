<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ an_actual_token }}">
    <title>Massage Shop POS - New Transaction</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="nav-header">
            NEW TRANSACTION
        </div>

        <div class="nav-buttons">
            <a href="/index.html" class="nav-btn home">üè† Home</a>
            <a href="/api/main/staff-roster" class="nav-btn staff">üë• Staff Roster</a>
            <a href="/api/main/transaction" class="nav-btn transaction active">üí≥ New Transaction</a>
            <a href="/api/main/summary" class="nav-btn summary">üìä Daily Summary</a>
                            <div class="user-info" id="user-info" style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                    <span id="current-user" style="color: #666; font-size: 14px;"></span>
                </div>
        </div>

        <!-- Correction Mode Banner -->
        <div id="correction-banner" class="correction-banner" style="display: none;">
            üîÑ CORRECTION MODE: Editing previous transaction
        </div>

        <div class="main-grid">
            <!-- Left Column: Transaction Form -->
            <div>
                <div class="section">
                    <div class="section-header">TRANSACTION DETAILS</div>
                    <div class="section-content">
                        <form id="transaction-form">
                            <div class="form-group">
                                <label for="masseuse">Masseuse Name:</label>
                                <select id="masseuse" required>
                                    <option value="">Select Masseuse</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="location">Service Location:</label>
                                <select id="location" required onchange="updateServiceOptions(); updatePricing(); updateTimeDropdowns();">
                                    <option value="">Select Location</option>
                                    <option value="In-Shop">In-Shop</option>
                                    <option value="Home Service">Home Service</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="service">Service Type:</label>
                                <select id="service" required onchange="updateDurationOptions(); updatePricing(); updateTimeDropdowns();">
                                    <option value="">Select Service</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="duration">Duration:</label>
                                <select id="duration" required onchange="updatePricing(); updateTimeDropdowns();">
                                    <option value="">Select Duration</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="payment">Payment Method:</label>
                                <select id="payment" required onchange="updateTimeDropdowns()">
                                    <option value="">Select Payment Method</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="startTime">Start Time:</label>
                                <input type="text" id="startTime" required readonly class="readonly">
                            </div>

                            <div class="form-group">
                                <label for="endTime">End Time:</label>
                                <select id="endTime" required>
                                    <option value="">Select End Time</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="customerContact">Customer Contact (Optional):</label>
                                <input type="text" id="customerContact" maxlength="100" placeholder="Phone or name (optional)">
                            </div>

                            <div class="form-group">
                                <label>Service Price:</label>
                                <div id="servicePrice" class="summary-value">‡∏ø0.00</div>
                            </div>

                            <div class="form-group">
                                <label>Masseuse Fee:</label>
                                <div id="masseuseeFee" class="summary-value">‡∏ø0.00</div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-large" style="width: 100%; margin-top: 20px;">
                                üí≥ Submit Transaction
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Correction Section -->
                <div class="section">
                    <div class="section-header">CORRECT MISTAKE</div>
                    <div class="section-content">
                        <div id="correction-info" style="margin: 10px 0; font-style: italic; color: #666;">
                            No recent transaction to correct
                        </div>
                        <button class="btn btn-secondary" onclick="loadCorrection()" style="width: 100%;">
                            üîÑ Load Last Transaction for Correction
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Mini Summary and Recent Transactions -->
            <div>
                <!-- Quick Daily Summary -->
                <div class="section">
                    <div class="section-header">TODAY'S QUICK SUMMARY</div>
                    <div class="section-content">
                        <div class="summary-grid">
                            <div class="summary-label">Today's Revenue:</div>
                            <div class="summary-value" id="today-revenue">‡∏ø0.00</div>
                        </div>
                        <div class="summary-grid">
                            <div class="summary-label">Today's Transactions:</div>
                            <div class="summary-value" id="today-count">0</div>
                        </div>
                        <div class="summary-grid">
                            <div class="summary-label">Today's Expenses:</div>
                            <div class="summary-value" id="today-expenses">‡∏ø0.00</div>
                        </div>
                        
                        <!-- Payment Breakdown -->
                        <h4 style="margin: 15px 0 10px 0; color: #4a86e8;">Today's Payment Breakdown:</h4>
                        <div id="payment-breakdown-mini"></div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="section">
                    <div class="section-header">RECENT TRANSACTIONS</div>
                    <div class="section-content">
                        <div class="transaction-log" id="recent-transactions">
                            <div class="transaction-item">
                                <div>Payment</div>
                                <div>Masseuse</div>
                                <div>Service</div>
                                <div>Amount</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Expenses -->
                <div class="section">
                    <div class="section-header">DAILY EXPENSES</div>
                    <div class="section-content">
                        <div id="expense-list"></div>
                        <div style="margin-top: 15px;">
                            <div class="expense-grid">
                                <input type="text" id="newExpenseDesc" placeholder="Expense description">
                                <input type="number" id="newExpenseAmount" placeholder="Amount" step="0.01" min="0">
                                <button class="btn btn-primary" onclick="handleAddExpense()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/api.js"></script>
    <script src="/shared.js"></script>
    <script>
        console.log('üöÄ TRANSACTION.HTML SCRIPT LOADING...');
        
        let correctionMode = false;

        console.log('üöÄ ADDING DOM CONTENT LOADED LISTENER...');
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ DOM LOADED - Starting initialization');
                
                // Check authentication first
                if (!requireAuth()) {
                    return;
                }
                
                // Display current user
                const user = getCurrentUser();
                if (user) {
                    document.getElementById('current-user').textContent = `${user.role} (${user.username})`;
                }
                
                await loadData(); // Load data from API first
                console.log('üöÄ DATA LOADED - CONFIG:', CONFIG);
                populateDropdowns(); // Then populate dropdowns with loaded data
                await updateAllDisplays();
                handleURLParams();
            } catch (error) {
                console.error('üö® CRITICAL ERROR in DOMContentLoaded:', error);
            }
            
            document.getElementById('transaction-form').addEventListener('submit', handleSubmit);
            
            setInterval(async () => {
                await updateAllDisplays();
            }, 30000);
        });

        function handleURLParams() {
            const params = new URLSearchParams(window.location.search);
            const masseuse = params.get('masseuse');
            if (masseuse) {
                document.getElementById('masseuse').value = masseuse;
            }
        }

        function populateDropdowns() {
            console.log('üîç POPULATE DROPDOWNS - CONFIG.settings:', CONFIG.settings);
            console.log('üîç Masseuses:', CONFIG.settings.masseuses);
            console.log('üîç Services:', CONFIG.settings.services);
            console.log('üîç Payment Methods:', CONFIG.settings.paymentMethods);
            
            const masseuseSelect = document.getElementById('masseuse');
            masseuseSelect.innerHTML = '<option value="">Select Masseuse</option>';
            
            // Find next in line masseuse for auto-selection
            const nextInLine = appData.roster.find(r => r.status === 'Next' || r.name === getNextInLineFromStaff());
            let nextInLineName = nextInLine ? nextInLine.name : null;
            
            CONFIG.settings.masseuses.forEach(name => {
                const isSelected = name === nextInLineName ? 'selected' : '';
                masseuseSelect.innerHTML += `<option value="${name}" ${isSelected}>${name}${name === nextInLineName ? ' (NEXT IN LINE)' : ''}</option>`;
            });

            // Initialize service and duration dropdowns with default state
            const serviceSelect = document.getElementById('service');
            const durationSelect = document.getElementById('duration');
            
            if (serviceSelect) {
                serviceSelect.innerHTML = '<option value="">Select Service</option>';
                console.log('‚úÖ Service dropdown initialized');
            } else {
                console.log('‚ùå Service dropdown element not found');
            }
            
            if (durationSelect) {
                durationSelect.innerHTML = '<option value="">Select Duration</option>';
                console.log('‚úÖ Duration dropdown initialized');
            } else {
                console.log('‚ùå Duration dropdown element not found');
            }

            const paymentSelect = document.getElementById('payment');
            paymentSelect.innerHTML = '<option value="">Select Payment Method</option>';
            CONFIG.settings.paymentMethods.forEach(method => {
                paymentSelect.innerHTML += `<option value="${method}">${method}</option>`;
            });
            
            console.log('üîç DROPDOWNS POPULATED - Next in line:', nextInLineName);
        }
        
        function getNextInLineFromStaff() {
            // Helper function to find next in line from roster data
            const nextStaff = appData.roster.find(r => r.status === 'Next');
            return nextStaff ? nextStaff.name : null;
        }

        function updateServiceOptions() {
            const location = document.getElementById('location').value;
            const serviceSelect = document.getElementById('service');
            const durationSelect = document.getElementById('duration');
            
            // Defensive programming: check if elements exist
            if (!serviceSelect || !durationSelect) {
                console.error('‚ùå updateServiceOptions: Required DOM elements not found');
                return;
            }
            
            serviceSelect.innerHTML = '<option value="">Select Service</option>';
            durationSelect.innerHTML = '<option value="">Select Duration</option>';
            
            if (location) {
                // Find unique service names for this location
                const locationServices = CONFIG.settings.services.filter(s => s.location === location);
                const uniqueServices = [...new Set(locationServices.map(s => s.name))];
                uniqueServices.forEach(serviceName => {
                    serviceSelect.innerHTML += `<option value="${serviceName}">${serviceName}</option>`;
                });
            }
        }

        function updateDurationOptions() {
            const location = document.getElementById('location').value;
            const serviceName = document.getElementById('service').value;
            const durationSelect = document.getElementById('duration');
            
            // Defensive programming: check if element exists
            if (!durationSelect) {
                console.error('‚ùå updateDurationOptions: Duration select element not found');
                return;
            }
            
            durationSelect.innerHTML = '<option value="">Select Duration</option>';
            
            if (location && serviceName) {
                // Find all durations for this service type and location
                const serviceOptions = CONFIG.settings.services.filter(s => 
                    s.name === serviceName && s.location === location
                );
                serviceOptions.forEach(service => {
                    durationSelect.innerHTML += `<option value="${service.duration}">${service.duration} minutes</option>`;
                });
            }
        }

        function updatePricing() {
            const location = document.getElementById('location').value;
            const serviceName = document.getElementById('service').value;
            const duration = document.getElementById('duration').value;
            
            if (location && serviceName && duration) {
                const service = CONFIG.settings.services.find(s => 
                    s.name === serviceName && s.duration == duration && s.location === location
                );
                
                if (service) {
                    document.getElementById('servicePrice').textContent = `‡∏ø${service.price.toFixed(2)}`;
                    document.getElementById('masseuseeFee').textContent = `‡∏ø${service.fee.toFixed(2)}`;
                } else {
                    document.getElementById('servicePrice').textContent = '‡∏ø0.00';
                    document.getElementById('masseuseeFee').textContent = '‡∏ø0.00';
                }
            } else {
                document.getElementById('servicePrice').textContent = '‡∏ø0.00';
                document.getElementById('masseuseeFee').textContent = '‡∏ø0.00';
            }
        }

        function updateTimeDropdowns() {
            // Get Bangkok time (UTC+7) instead of device time
            const now = new Date();
            const bangkokOffset = 7 * 60; // UTC+7 in minutes
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
            const bangkokTime = new Date(utcTime + (bangkokOffset * 60000));
            
            // Get preparation delay based on service (10min default, 15min for Oil)
            const serviceName = document.getElementById('service').value;
            const isOilService = serviceName && serviceName.toLowerCase().includes('oil');
            const preparationMinutes = isOilService ? 15 : 10;
            
            // Start time = Bangkok time + preparation delay
            const startTime = new Date(bangkokTime.getTime() + preparationMinutes * 60000);
            document.getElementById('startTime').value = formatTime(startTime);

            const endTimeSelect = document.getElementById('endTime');
            endTimeSelect.innerHTML = '<option value="">Select End Time</option>';

            // End time options based on start time + service duration
            const durations = [30, 60, 90, 120];
            durations.forEach(duration => {
                const endTime = new Date(startTime.getTime() + duration * 60000);
                const formattedEndTime = formatTime(endTime);
                endTimeSelect.innerHTML += `<option value="${formattedEndTime}">${formattedEndTime}</option>`;
            });
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const selectedMasseuse = document.getElementById('masseuse').value;
            const nextInLineName = getNextInLineFromStaff();
            const isUsingNextInLine = selectedMasseuse === nextInLineName;
            
            const location = document.getElementById('location').value;
            const serviceName = document.getElementById('service').value;
            const duration = document.getElementById('duration').value;
            
            const formData = {
                masseuse: selectedMasseuse,
                service: serviceName, // Send exact service_name, not constructed string
                payment: document.getElementById('payment').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                customerContact: document.getElementById('customerContact').value
            };

            const success = await submitTransaction(formData);
            if (success) {
                // If using next in line, advance the queue
                if (isUsingNextInLine) {
                    await advanceQueue(selectedMasseuse);
                }
                
                // Mark masseuse as busy until end time
                await setMasseuseBusy(selectedMasseuse, formData.endTime);
                
                clearForm();
                await updateAllDisplays();
                showToast(`Transaction submitted! ${selectedMasseuse} is now busy until ${formData.endTime}`);
            }
        }
        
        async function advanceQueue(currentMasseuse) {
            try {
                // Advance to next person in line
                await api.advanceQueue(currentMasseuse);
                console.log(`üîÑ Queue advanced from ${currentMasseuse}`);
            } catch (error) {
                console.error('Error advancing queue:', error);
            }
        }
        
        async function setMasseuseBusy(masseuseName, endTime) {
            try {
                // Set masseuse as busy until end time
                await api.setMasseuseBusy(masseuseName, endTime);
                console.log(`üîí ${masseuseName} marked as busy until ${endTime}`);
            } catch (error) {
                console.error('Error setting masseuse busy:', error);
            }
        }

        function clearForm() {
            document.getElementById('transaction-form').reset();
            document.getElementById('servicePrice').textContent = '‡∏ø0.00';
            document.getElementById('masseuseeFee').textContent = '‡∏ø0.00';
            exitCorrectionMode();
        }

        async function loadCorrection() {
            const transaction = loadTransactionForCorrection();
            if (transaction) {
                document.getElementById('masseuse').value = transaction.masseuse;
                document.getElementById('service').value = transaction.service;
                document.getElementById('payment').value = transaction.paymentMethod;
                document.getElementById('startTime').value = transaction.startTime;
                document.getElementById('endTime').value = transaction.endTime;
                document.getElementById('customerContact').value = transaction.customerContact;
                
                updatePricing();
                enterCorrectionMode();
                await updateAllDisplays();
            }
        }

        function enterCorrectionMode() {
            correctionMode = true;
            document.getElementById('correction-banner').style.display = 'block';
            document.getElementById('transaction-form').classList.add('correction-mode');
            document.getElementById('correction-info').textContent = `Correcting transaction: ${appData.originalTransactionId}`;
        }

        function exitCorrectionMode() {
            correctionMode = false;
            document.getElementById('correction-banner').style.display = 'none';
            document.getElementById('transaction-form').classList.remove('correction-mode');
            document.getElementById('correction-info').textContent = 'No recent transaction to correct';
        }

        async function updateAllDisplays() {
            await updateQuickSummary();
            updateRecentTransactions();
            updateExpenseDisplay();
        }

        async function updateQuickSummary() {
            const summary = await getTodaySummary();
            
            // Safely handle summary data with defaults
            const todayRevenue = (summary && typeof summary.todayRevenue === 'number') ? summary.todayRevenue : 0;
            const todayCount = (summary && typeof summary.todayCount === 'number') ? summary.todayCount : 0;
            const todayExpenses = (summary && typeof summary.todayExpenses === 'number') ? summary.todayExpenses : 0;
            
            document.getElementById('today-revenue').textContent = `‡∏ø${todayRevenue.toFixed(2)}`;
            document.getElementById('today-count').textContent = todayCount;
            document.getElementById('today-expenses').textContent = `‡∏ø${todayExpenses.toFixed(2)}`;
            
            // Update payment breakdown
            if (summary) {
                updatePaymentBreakdownMini(summary);
            }
        }

        function updatePaymentBreakdownMini(summary) {
            const container = document.getElementById('payment-breakdown-mini');
            
            if (!summary || !summary.paymentBreakdown || Object.keys(summary.paymentBreakdown).length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">No payments yet today</div>';
                return;
            }

            let html = '';
            Object.entries(summary.paymentBreakdown)
                .sort(([,a], [,b]) => b.revenue - a.revenue)
                .forEach(([method, data]) => {
                    html += `
                        <div class="summary-grid" style="margin-bottom: 8px;">
                            <div style="font-size: 14px;">${method}:</div>
                            <div style="font-size: 14px; font-weight: bold; color: #34a853;">‡∏ø${data.revenue.toFixed(2)} (${data.count})</div>
                        </div>
                    `;
                });
            container.innerHTML = html;
        }

        function updateRecentTransactions() {
            const container = document.getElementById('recent-transactions');
            const recentTransactions = getRecentTransactions(5);

            // Preserve the header before clearing
            const headerHTML = `
                <div class="transaction-item">
                    <div>Payment</div>
                    <div>Masseuse</div>
                    <div>Service</div>
                    <div>Amount</div>
                </div>
            `;
            
            container.innerHTML = headerHTML;

            if (recentTransactions.length === 0) {
                const div = document.createElement('div');
                div.className = 'empty-state';
                div.innerHTML = '<div>No transactions yet today</div>';
                container.appendChild(div);
                return;
            }

            recentTransactions.forEach(transaction => {
                const div = document.createElement('div');
                div.className = 'transaction-item';
                div.innerHTML = `
                    <div>${transaction.paymentMethod}</div>
                    <div>${transaction.masseuse}</div>
                    <div>${transaction.service}</div>
                    <div>‡∏ø${transaction.paymentAmount.toFixed(2)}</div>
                `;
                container.appendChild(div);
            });
        }

        function updateExpenseDisplay() {
            const expenseList = document.getElementById('expense-list');
            
            if (appData.expenses.length === 0) {
                expenseList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No expenses recorded today</div>';
                return;
            }

            expenseList.innerHTML = appData.expenses.map((expense, index) => `
                <div class="expense-grid">
                    <div>${expense.description}</div>
                    <div>‡∏ø${expense.amount.toFixed(2)}</div>
                    <div><button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="handleRemoveExpense(${index})">Remove</button></div>
                    <div class="expense-time">${formatTime(expense.timestamp)}</div>
                </div>
            `).join('');
        }

        async function handleAddExpense() {
            const description = document.getElementById('newExpenseDesc').value.trim();
            const amount = parseFloat(document.getElementById('newExpenseAmount').value);

            if (addExpense(description, amount)) {
                document.getElementById('newExpenseDesc').value = '';
                document.getElementById('newExpenseAmount').value = '';
                await updateAllDisplays();
            }
        }

        async function handleRemoveExpense(index) {
            if (removeExpense(index)) {
                await updateAllDisplays();
            }
        }
    </script>
    
    <!-- Logout Button at Bottom -->
    <div style="text-align: center; padding: 20px; margin-top: 20px; border-top: 1px solid #dee2e6;">
        <button onclick="logout()" class="btn" style="background: #ff4444; color: white; padding: 10px 20px;">üëã Logout</button>
    </div>
</body>
</html>
