<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Massage Shop POS - Home</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="nav-header">
            MASSAGE SHOP POS SYSTEM
        </div>

        <div class="nav-buttons">
            <a href="index.html" class="nav-btn home active">üè† Home</a>
            <a href="/api/main/staff-roster" class="nav-btn staff">üë• Staff Roster</a>
            <a href="/api/main/transaction" class="nav-btn transaction">üí≥ New Transaction</a>
            <a href="/api/main/summary" class="nav-btn summary">üìä Daily Summary</a>
            <div class="user-info" id="user-info" style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                <span id="current-user" style="color: #666; font-size: 14px;"></span>
            </div>
        </div>

        <!-- Dashboard Overview -->
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>Today's Revenue</h3>
                <div class="big-number" id="today-revenue">‡∏ø0.00</div>
                <div class="subtitle" id="today-transactions">0 transactions</div>
            </div>
            
            <div class="dashboard-card">
                <h3>Active Staff</h3>
                <div class="big-number" id="active-staff">0</div>
                <div class="subtitle" id="available-staff">0 available</div>
            </div>
            
            <div class="dashboard-card">
                <h3>Today's Expenses</h3>
                <div class="big-number" id="today-expenses">‡∏ø0.00</div>
                <div class="subtitle" id="expense-count">0 expenses</div>
            </div>
            
            <div class="dashboard-card">
                <h3>All-Time Revenue</h3>
                <div class="big-number" id="total-revenue">‡∏ø0.00</div>
                <div class="subtitle">Historical total</div>
            </div>
        </div>

        <!-- Admin Access (Manager Only) -->
        <div class="section" id="admin-section" style="display: none;">
            <div class="section-header">ADMINISTRATION (Manager Only)</div>
            <div class="section-content">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <a href="/api/admin/staff-page" class="btn btn-primary btn-large">
                        üë• Staff Administration
                    </a>
                    <a href="/api/admin/services-page" class="btn btn-secondary btn-large">
                        üí∞ Services & Pricing
                    </a>
                    <a href="/api/admin/reports-page" class="btn btn-secondary btn-large">
                        üìä Financial Reports
                    </a>
                    <a href="/api/admin/payment-types-page" class="btn btn-secondary btn-large">
                        üí≥ Payment Types
                    </a>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="section">
            <div class="section-header">RECENT ACTIVITY</div>
            <div class="section-content">
                <div class="transaction-log" id="recent-activity">
                                    <div class="transaction-item">
                    <div>Time</div>
                    <div>Activity</div>
                    <div>Masseuse</div>
                    <div>Duration</div>
                    <div>Location</div>
                    <div>Amount</div>
                </div>
                </div>
            </div>
        </div>

        <!-- Quick Summary -->
        <div class="section">
            <div class="section-header">TODAY'S BREAKDOWN</div>
            <div class="section-content">
                <div id="payment-breakdown"></div>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication first
            if (!requireAuth()) {
                return;
            }
            
            // Display current user and show admin section for managers
            const user = getCurrentUser();
            if (user) {
                document.getElementById('current-user').textContent = `${user.role} (${user.username})`;
                
                // Show admin section only for managers
                if (user.role === 'manager') {
                    document.getElementById('admin-section').style.display = 'block';
                }
            }
            
            await updateDashboard();
            await updateRecentActivity();
            await updatePaymentBreakdown();
            setInterval(async () => {
                await updateDashboard();
                await updateRecentActivity();
                await updatePaymentBreakdown();
            }, 30000);
        });

        async function updateDashboard() {
            const summary = await getTodaySummary();
            document.getElementById('today-revenue').textContent = `‡∏ø${summary.todayRevenue.toFixed(2)}`;
            document.getElementById('today-transactions').textContent = `${summary.todayCount} transaction${summary.todayCount !== 1 ? 's' : ''}`;
            
            const activeStaff = appData.roster.filter(m => m.name && m.status !== 'Off').length;
            const availableStaff = appData.roster.filter(m => m.name && (m.status === 'Available' || m.status === 'Next')).length;
            document.getElementById('active-staff').textContent = activeStaff;
            document.getElementById('available-staff').textContent = `${availableStaff} available`;
            
            document.getElementById('today-expenses').textContent = `‡∏ø${summary.todayExpenses.toFixed(2)}`;
            document.getElementById('expense-count').textContent = `${appData.expenses.length} expense${appData.expenses.length !== 1 ? 's' : ''}`;
            document.getElementById('total-revenue').textContent = `‡∏ø${summary.allTimeRevenue.toFixed(2)}`;
        }

        function updateRecentActivity() {
            const container = document.getElementById('recent-activity');
            const recentTransactions = getRecentTransactions(5);
            const recentExpenses = appData.expenses.slice(-3).reverse();
            
            const allActivity = [
                ...recentTransactions.map(t => ({
                    type: 'transaction', timestamp: t.timestamp, description: t.service,
                    masseuse: t.masseuse, duration: t.duration, location: t.location, amount: t.paymentAmount
                })),
                ...recentExpenses.map(e => ({
                    type: 'expense', timestamp: e.timestamp, description: e.description,
                    masseuse: 'Expense', duration: '-', location: '-', amount: e.amount
                }))
            ].sort((a, b) => b.timestamp - a.timestamp).slice(0, 5);

            const header = container.querySelector('.transaction-item');
            container.innerHTML = '';
            container.appendChild(header);

            if (allActivity.length === 0) {
                const div = document.createElement('div');
                div.className = 'empty-state';
                div.innerHTML = '<div class="icon">üìã</div><div>No activity yet today</div>';
                container.appendChild(div);
                return;
            }

            allActivity.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'transaction-item';
                const icon = activity.type === 'transaction' ? 'üí≥' : 'üí∞';
                const color = activity.type === 'transaction' ? '#34a853' : '#ea4335';
                const prefix = activity.type === 'transaction' ? '+' : '-';
                div.innerHTML = `
                    <div>${formatTime(activity.timestamp)}</div>
                    <div>${icon} ${activity.description}</div>
                    <div>${activity.masseuse}</div>
                    <div>${activity.duration}</div>
                    <div>${activity.location}</div>
                    <div style="color: ${color}">${prefix}‡∏ø${activity.amount.toFixed(2)}</div>
                `;
                container.appendChild(div);
            });
        }

        async function updatePaymentBreakdown() {
            const summary = await getTodaySummary();
            const container = document.getElementById('payment-breakdown');
            
            if (!summary || !summary.paymentBreakdown || Object.keys(summary.paymentBreakdown).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üí≥</div><div>No payments processed today</div></div>';
                return;
            }

            let html = '<table class="payment-table"><tr><th>Payment Method</th><th>Count</th><th class="amount">Revenue</th></tr>';
            Object.entries(summary.paymentBreakdown)
                .sort(([,a], [,b]) => b.revenue - a.revenue)
                .forEach(([method, data]) => {
                    html += `<tr><td>${method}</td><td>${data.count}</td><td class="amount">‡∏ø${data.revenue.toFixed(2)}</td></tr>`;
                });
            html += '</table>';
            container.innerHTML = html;
        }

        // Functions removed: handleServeNext and handleEndDay (Quick Actions deprecated)
    </script>
    
    <!-- Logout Button at Bottom -->
    <div style="text-align: center; padding: 20px; margin-top: 20px; border-top: 1px solid #dee2e6;">
        <button onclick="logout()" class="btn" style="background: #ff4444; color: white; padding: 10px 20px;">üëã Logout</button>
    </div>
</body>
</html>