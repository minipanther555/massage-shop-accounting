<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - EIW Massage Shop POS</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="login-form">
            <h1>EIW Massage Shop</h1>
            <h2>Point of Sale System</h2>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Role:</label>
                    <select id="username" name="username" required>
                        <option value="">Select your role</option>
                        <option value="reception">Reception</option>
                        <option value="manager">Manager</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" id="loginBtn">Login</button>
            </form>
            
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="loading" class="loading" style="display: none;">Logging in...</div>
            
            <!-- Role Information Section -->
            <div class="role-info">
                <strong>Reception:</strong> Password: <code>reception123</code> - Access to transactions, daily roster, basic reporting<br>
                <strong>Manager:</strong> Password: <code>manager456</code> - All reception features + staff management, advanced settings
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê LOGIN PAGE: Script loading...');
            
            // Check for existing session
            console.log('üîê LOGIN PAGE: Checking existing session...');
            const sessionToken = localStorage.getItem('sessionToken');
            const currentUser = localStorage.getItem('currentUser');
            
            if (sessionToken && currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    console.log('üîê LOGIN PAGE: Found existing session for user:', user.role);
                    
                    // Redirect to main app
                    window.location.href = 'index.html';
                    return;
                } catch (error) {
                    console.error('üîê LOGIN PAGE: Error parsing stored user data:', error);
                    localStorage.removeItem('sessionToken');
                    localStorage.removeItem('currentUser');
                }
            }
            
            // Get form elements
            const loginForm = document.getElementById('loginForm');
            const username = document.getElementById('username');
            const password = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('errorMessage');
            
            // Handle form submission
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const usernameValue = username.value;
                const passwordValue = password.value;
                
                // Clear previous errors
                errorDiv.textContent = '';
                
                // Validate form
                if (!usernameValue) {
                    showError('Please select your role');
                    return;
                }
                
                if (!passwordValue) {
                    showError('Please enter your password');
                    return;
                }
                
                // Show loading state
                loginBtn.disabled = true;
                loading.style.display = 'block';
                
                try {
                    console.log('üîê ATTEMPTING LOGIN:', { username: usernameValue, passwordProvided: passwordValue !== '' });
                    
                    const response = await api.login(usernameValue, passwordValue);
                    
                    if (response.success) {
                        console.log('‚úÖ LOGIN SUCCESS:', response.user);
                        
                        // Store session data
                        localStorage.setItem('sessionToken', response.sessionId);
                        localStorage.setItem('currentUser', JSON.stringify(response.user));
                        
                        // Show success message briefly
                        showSuccess(`Welcome ${response.user.role}!`);
                        
                        // Redirect after brief delay
                        setTimeout(() => {
                            redirectToApp(response.user.role);
                        }, 1000);
                        
                    } else {
                        console.log('‚ùå LOGIN FAILED:', response);
                        showError('Login failed. Please check your credentials.');
                    }
                    
                } catch (error) {
                    console.error('üö® LOGIN ERROR:', error);
                    showError(error.message || 'Login failed. Please try again.');
                } finally {
                    // Hide loading state
                    loginBtn.disabled = false;
                    loading.style.display = 'none';
                }
            });
            
            function showError(message) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#ffebee';
                errorDiv.style.color = '#c62828';
            }
            
            function showSuccess(message) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#e8f5e8';
                errorDiv.style.color = '#2e7d32';
            }
            
            function redirectToApp(role) {
                console.log('üöÄ REDIRECTING USER:', { role });
                
                // Both roles go to main app initially
                // Later: manager could go to admin dashboard
                window.location.href = 'index.html';
            }
            
            // Handle Enter key in password field
            password.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginForm.dispatchEvent(new Event('submit'));
                }
            });
            
            // Update role info when username changes
            username.addEventListener('change', function() {
                const usernameValue = this.value;
                const roleInfo = document.querySelector('.role-info');
                
                if (usernameValue === 'reception') {
                    roleInfo.innerHTML = '<strong>Reception Access:</strong> Password: <code>reception123</code><br>Create transactions, manage daily staff roster, view basic reports, track expenses';
                } else if (usernameValue === 'manager') {
                    roleInfo.innerHTML = '<strong>Manager Access:</strong> Password: <code>manager456</code><br>All reception features + master staff management, advanced reporting, system settings, end day operations';
                } else {
                    roleInfo.innerHTML = '<strong>Reception:</strong> Password: <code>reception123</code> - Access to transactions, daily roster, basic reporting<br><strong>Manager:</strong> Password: <code>manager456</code> - All reception features + staff management, advanced settings';
                }
            });
        });
    </script>
</body>
</html>
