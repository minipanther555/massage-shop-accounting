<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - EIW Massage Shop</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        console.log('üîç [HYPOTHESIS TEST] ==========================================');
        console.log('üîç [HYPOTHESIS TEST] LOGIN.HTML HEAD SCRIPT - TESTING ALL 5 HYPOTHESES');
        console.log('üîç [HYPOTHESIS TEST] ==========================================');
        console.log('üîç [HYPOTHESIS TEST] Head script executed at:', new Date().toISOString());
        console.log('üîç [HYPOTHESIS TEST] Window location:', window.location.href);
        console.log('üîç [HYPOTHESIS TEST] Document readyState:', document.readyState);
        
        // Test Hypothesis 1: Environment Variable Missing
        console.log('üîç [HYPOTHESIS 1] Testing: Environment Variable Missing');
        console.log('üîç [HYPOTHESIS 1] Global window.API_BASE_URL:', window.API_BASE_URL);
        console.log('üîç [HYPOTHESIS 1] Global window.apiBaseUrl:', window.apiBaseUrl);
        console.log('üîç [HYPOTHESIS 1] Global window.config:', window.config);
        
        // Test Hypothesis 2: Configuration File Loading Issue
        console.log('üîç [HYPOTHESIS 2] Testing: Configuration File Loading Issue');
        console.log('üîç [HYPOTHESIS 2] Scripts loaded in head:', document.head.querySelectorAll('script').length);
        console.log('üîç [HYPOTHESIS 2] Head script sources:', Array.from(document.head.querySelectorAll('script')).map(s => s.src || 'inline'));
        
        // Test Hypothesis 3: Script Loading Order Problem
        console.log('üîç [HYPOTHESIS 3] Testing: Script Loading Order Problem');
        console.log('üîç [HYPOTHESIS 3] Head script execution time:', performance.now());
        console.log('üîç [HYPOTHESIS 3] DOM ready state at head script:', document.readyState);
        
        // Test Hypothesis 4: Browser Caching Issue
        console.log('üîç [HYPOTHESIS 4] Testing: Browser Caching Issue');
        console.log('üîç [HYPOTHESIS 4] Head script execution successful');
        
        // Test Hypothesis 5: Configuration Override Problem
        console.log('üîç [HYPOTHESIS 5] Testing: Configuration Override Problem');
        console.log('üîç [HYPOTHESIS 5] Global variables state at head script:');
        console.log('üîç [HYPOTHESIS 5] - window.API_BASE_URL:', window.API_BASE_URL);
        console.log('üîç [HYPOTHESIS 5] - window.apiBaseUrl:', window.apiBaseUrl);
        console.log('üîç [HYPOTHESIS 5] - window.config:', window.config);
        
        console.log('üîç [HYPOTHESIS TEST] ==========================================');
        console.log('üîç [HYPOTHESIS TEST] HEAD SCRIPT COMPLETED - ALL HYPOTHESES TESTED');
        console.log('üîç [HYPOTHESIS TEST] ==========================================');
    </script>
</head>
<body>
    <div class="container">
        <div class="login-form">
            <h1>EIW Massage Shop</h1>
            <h2>Login</h2>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit">Login</button>
            </form>
            
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="shared.js"></script>
    <script>
        console.log('üîç [HYPOTHESIS TEST] ==========================================');
        console.log('üîç [HYPOTHESIS TEST] LOGIN.HTML BODY SCRIPT - TESTING ALL 5 HYPOTHESES');
        console.log('üîç [HYPOTHESIS TEST] ==========================================');
        console.log('üîç [HYPOTHESIS TEST] Body script started at:', new Date().toISOString());
        console.log('üîç [HYPOTHESIS TEST] Window location:', window.location.href);
        console.log('üîç [HYPOTHESIS TEST] Document readyState:', document.readyState);
        
        // Test Hypothesis 1: Environment Variable Missing
        console.log('üîç [HYPOTHESIS 1] Testing: Environment Variable Missing');
        console.log('üîç [HYPOTHESIS 1] Global window.API_BASE_URL:', window.API_BASE_URL);
        console.log('üîç [HYPOTHESIS 1] Global window.apiBaseUrl:', window.apiBaseUrl);
        console.log('üîç [HYPOTHESIS 1] Global window.config:', window.config);
        console.log('üîç [HYPOTHESIS 1] Global window.CONFIG:', window.CONFIG);
        
        // Test Hypothesis 2: Configuration File Loading Issue
        console.log('üîç [HYPOTHESIS 2] Testing: Configuration File Loading Issue');
        console.log('üîç [HYPOTHESIS 2] Scripts loaded in body:', document.body.querySelectorAll('script').length);
        console.log('üîç [HYPOTHESIS 2] Body script sources:', Array.from(document.body.querySelectorAll('script')).map(s => s.src || 'inline'));
        console.log('üîç [HYPOTHESIS 2] All scripts loaded:', document.scripts.length);
        console.log('üîç [HYPOTHESIS 2] Script loading order:', Array.from(document.scripts).map(s => s.src || 'inline'));
        
        // Test Hypothesis 3: Script Loading Order Problem
        console.log('üîç [HYPOTHESIS 3] Testing: Script Loading Order Problem');
        console.log('üîç [HYPOTHESIS 3] Body script execution time:', performance.now());
        console.log('üîç [HYPOTHESIS 3] DOM ready state at body script:', document.readyState);
        console.log('üîç [HYPOTHESIS 3] Window load event fired:', window.performance.getEntriesByType('navigation')[0]?.loadEventEnd > 0);
        console.log('üîç [HYPOTHESIS 3] DOMContentLoaded fired:', document.readyState === 'interactive' || document.readyState === 'complete');
        
        // Test Hypothesis 4: Browser Caching Issue
        console.log('üîç [HYPOTHESIS 4] Testing: Browser Caching Issue');
        console.log('üîç [HYPOTHESIS 4] Body script execution successful');
        console.log('üîç [HYPOTHESIS 4] Current script execution time:', performance.now());
        
        // Test Hypothesis 5: Configuration Override Problem
        console.log('üîç [HYPOTHESIS 5] Testing: Configuration Override Problem');
        console.log('üîç [HYPOTHESIS 5] Global variables state at body script:');
        console.log('üîç [HYPOTHESIS 5] - window.API_BASE_URL:', window.API_BASE_URL);
        console.log('üîç [HYPOTHESIS 5] - window.apiBaseUrl:', window.apiBaseUrl);
        console.log('üîç [HYPOTHESIS 5] - window.config:', window.config);
        console.log('üîç [HYPOTHESIS 5] - window.CONFIG:', window.CONFIG);
        
        console.log('üîç [HYPOTHESIS TEST] ==========================================');
        console.log('üîç [HYPOTHESIS TEST] CHECKING GLOBAL OBJECTS - TESTING ALL 5 HYPOTHESES');
        console.log('üîç [HYPOTHESIS TEST] ==========================================');
        
        // Check global objects after script loading
        console.log('üîç [HYPOTHESIS TEST] Global api object exists:', typeof window.api !== 'undefined');
        console.log('üîç [HYPOTHESIS TEST] Global api object type:', typeof window.api);
        console.log('üîç [HYPOTHESIS TEST] Global api object constructor:', window.api?.constructor?.name);
        
        console.log('üîç [HYPOTHESIS TEST] Global APIClient class exists:', typeof window.APIClient !== 'undefined');
        console.log('üîç [HYPOTHESIS TEST] Global APIClient class type:', typeof window.APIClient);
        
        console.log('üîç [HYPOTHESIS TEST] Global showToast function exists:', typeof window.showToast !== 'undefined');
        console.log('üîç [HYPOTHESIS TEST] Global showToast function type:', typeof window.showToast);
        
        // Test Hypothesis 1: Environment Variable Missing
        console.log('üîç [HYPOTHESIS 1] Testing: Environment Variable Missing');
        console.log('üîç [HYPOTHESIS 1] API_BASE_URL from global api object:', window.api?.API_BASE_URL);
        console.log('üîç [HYPOTHESIS 1] API_BASE_URL type:', typeof window.api?.API_BASE_URL);
        console.log('üîç [HYPOTHESIS 1] API_BASE_URL === undefined:', window.api?.API_BASE_URL === undefined);
        console.log('üîç [HYPOTHESIS 1] API_BASE_URL === null:', window.api?.API_BASE_URL === null);
        console.log('üîç [HYPOTHESIS 1] API_BASE_URL === "":', window.api?.API_BASE_URL === '');
        
        // Test Hypothesis 2: Configuration File Loading Issue
        console.log('üîç [HYPOTHESIS 2] Testing: Configuration File Loading Issue');
        console.log('üîç [HYPOTHESIS 2] Global api object loaded:', window.api !== undefined);
        console.log('üîç [HYPOTHESIS 2] Global api object is APIClient instance:', window.api instanceof (window.APIClient || Object));
        console.log('üîç [HYPOTHESIS 2] APIClient class available:', typeof window.APIClient !== 'undefined');
        
        // Test Hypothesis 3: Script Loading Order Problem
        console.log('üîç [HYPOTHESIS 3] Testing: Script Loading Order Problem');
        console.log('üîç [HYPOTHESIS 3] Document readyState at body script:', document.readyState);
        console.log('üîç [HYPOTHESIS 3] Window load event fired at body script:', window.performance.getEntriesByType('navigation')[0]?.loadEventEnd > 0);
        console.log('üîç [HYPOTHESIS 3] Script execution order check:', performance.now());
        
        // Test Hypothesis 4: Browser Caching Issue
        console.log('üîç [HYPOTHESIS 4] Testing: Browser Caching Issue');
        console.log('üîç [HYPOTHESIS 4] Body script execution successful');
        console.log('üîç [HYPOTHESIS 4] Current script execution time:', performance.now());
        
        // Test Hypothesis 5: Configuration Override Problem
        console.log('üîç [HYPOTHESIS 5] Testing: Configuration Override Problem');
        console.log('üîç [HYPOTHESIS 5] Has global api object been modified since creation?');
        console.log('üîç [HYPOTHESIS 5] Current global api object:', window.api);
        console.log('üîç [HYPOTHESIS 5] Expected api object type:', 'APIClient instance');
        
        console.log('üîç [HYPOTHESIS TEST] ==========================================');
        console.log('üîç [HYPOTHESIS TEST] INLINE SCRIPT IN LOGIN.HTML HAS STARTED.');
        console.log('üîç [HYPOTHESIS TEST] ==========================================');
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîç [HYPOTHESIS TEST] ==========================================');
            console.log('üîç [HYPOTHESIS TEST] DOMCONTENTLOADED EVENT - TESTING ALL 5 HYPOTHESES');
            console.log('üîç [HYPOTHESIS TEST] ==========================================');
            console.log('üîç [HYPOTHESIS TEST] DOMContentLoaded fired at:', new Date().toISOString());
            console.log('üîç [HYPOTHESIS TEST] Document readyState:', document.readyState);
            console.log('üîç [HYPOTHESIS TEST] Event timing:', performance.now());
            
            // Test Hypothesis 1: Environment Variable Missing
            console.log('üîç [HYPOTHESIS 1] Testing: Environment Variable Missing');
            console.log('üîç [HYPOTHESIS 1] API_BASE_URL at DOMContentLoaded:', window.api?.API_BASE_URL);
            console.log('üîç [HYPOTHESIS 1] API_BASE_URL type at DOMContentLoaded:', typeof window.api?.API_BASE_URL);
            
            // Test Hypothesis 2: Configuration File Loading Issue
            console.log('üîç [HYPOTHESIS 2] Testing: Configuration File Loading Issue');
            console.log('üîç [HYPOTHESIS 2] Global api object at DOMContentLoaded:', window.api);
            console.log('üîç [HYPOTHESIS 2] APIClient class at DOMContentLoaded:', window.APIClient);
            
            // Test Hypothesis 3: Script Loading Order Problem
            console.log('üîç [HYPOTHESIS 3] Testing: Script Loading Order Problem');
            console.log('üîç [HYPOTHESIS 3] DOM ready state at DOMContentLoaded:', document.readyState);
            console.log('üîç [HYPOTHESIS 3] Event timing at DOMContentLoaded:', performance.now());
            
            // Test Hypothesis 4: Browser Caching Issue
            console.log('üîç [HYPOTHESIS 4] Testing: Browser Caching Issue');
            console.log('üîç [HYPOTHESIS 4] DOMContentLoaded event successful');
            
            // Test Hypothesis 5: Configuration Override Problem
            console.log('üîç [HYPOTHESIS 5] Testing: Configuration Override Problem');
            console.log('üîç [HYPOTHESIS 5] Global api object state at DOMContentLoaded:', window.api);
            console.log('üîç [HYPOTHESIS 5] Expected state at DOMContentLoaded:', 'APIClient instance with valid API_BASE_URL');
            
            console.log('üîç [HYPOTHESIS TEST] ==========================================');
            console.log('üîç [HYPOTHESIS TEST] DOMCONTENTLOADED COMPLETED - ALL HYPOTHESES TESTED');
            console.log('üîç [HYPOTHESIS TEST] ==========================================');
            
            // Check if showToast function is available
            if (typeof showToast === 'function') {
                console.log('HYPOTHESIS LOG: showToast() from shared.js is DEFINED.');
            } else {
                console.error('HYPOTHESIS LOG: showToast() from shared.js is NOT DEFINED!');
            }
            
            // Check if global api object is available
            if (typeof window.api !== 'undefined' && window.api instanceof (window.APIClient || Object)) {
                console.log('HYPOTHESIS LOG: Global `api` object from api.js is DEFINED and is an instance of APIClient.');
                console.log('HYPOTHESIS LOG: api.API_BASE_URL =', window.api.API_BASE_URL);
                console.log('HYPOTHESIS LOG: api.API_BASE_URL type =', typeof window.api.API_BASE_URL);
            } else {
                console.error('HYPOTHESIS LOG: Global `api` object from api.js is NOT DEFINED or is not an APIClient instance!');
                console.error('HYPOTHESIS LOG: window.api =', window.api);
                console.error('HYPOTHESIS LOG: typeof window.api =', typeof window.api);
            }
            
            console.log('üîê LOGIN PAGE: Script loading...');
            
            // Check existing session
            console.log('üîê LOGIN PAGE: Checking existing session...');
            
            const sessionToken = localStorage.getItem('sessionToken');
            if (sessionToken) {
                try {
                    const session = await api.checkSession();
                    if (session.valid) {
                        console.log('‚úÖ EXISTING SESSION FOUND:', session.user);
                        redirectToApp(session.user.role);
                        return;
                    }
                } catch (error) {
                    console.log('‚ùå EXISTING SESSION INVALID, clearing...');
                    localStorage.removeItem('sessionToken');
                    localStorage.removeItem('currentUser');
                }
            }
            
            // Focus on username field
            document.getElementById('username').focus();
        });
        
        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            const loginBtn = document.querySelector('button[type="submit"]');
            const loading = document.getElementById('loading');
            
            // Clear previous errors
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            
            // Validate form
            if (!username) {
                showError('Please select your role');
                return;
            }
            
            if (!password) {
                showError('Please enter your password');
                return;
            }
            
            // Show loading state
            loginBtn.disabled = true;
            loading.style.display = 'block';
            
            try {
                console.log('üîê ATTEMPTING LOGIN:', { username, passwordProvided: password !== '' });
                
                const response = await api.login(username, password);
                
                if (response.success) {
                    console.log('‚úÖ LOGIN SUCCESS:', response.user);
                    
                    // Store session data
                    localStorage.setItem('sessionToken', response.sessionId);
                    localStorage.setItem('currentUser', JSON.stringify(response.user));
                    
                    // Show success message briefly
                    showSuccess(`Welcome ${response.user.role}!`);
                    
                    // Redirect after brief delay
                    setTimeout(() => {
                        redirectToApp(response.user.role);
                    }, 1000);
                    
                } else {
                    console.log('‚ùå LOGIN FAILED:', response);
                    showError('Login failed. Please check your credentials.');
                }
                
            } catch (error) {
                console.error('üö® LOGIN ERROR:', error);
                showError(error.message || 'Login failed. Please try again.');
            } finally {
                // Hide loading state
                loginBtn.disabled = false;
                loading.style.display = 'none';
            }
        });
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#ffebee';
            errorDiv.style.color = '#c62828';
        }
        
        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#e8f5e8';
            errorDiv.style.color = '#2e7d32';
        }
        
        function redirectToApp(role) {
            console.log('üöÄ REDIRECTING USER:', { role });
            
            // Both roles go to main app initially
            // Later: manager could go to admin dashboard
            window.location.href = 'index.html';
        }
        
        // Handle Enter key in password field
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginForm').dispatchEvent(new Event('submit'));
            }
        });
        
        // Update role info when username changes
        document.getElementById('username').addEventListener('change', function() {
            const username = this.value;
            const roleInfo = document.querySelector('.role-info');
            
            if (username === 'reception') {
                roleInfo.innerHTML = '<strong>Reception Access:</strong> Password: <code>reception123</code><br>Create transactions, manage daily staff roster, view basic reports, track expenses';
            } else if (username === 'manager') {
                roleInfo.innerHTML = '<strong>Manager Access:</strong> Password: <code>manager456</code><br>All reception features + master staff management, advanced reporting, system settings, end day operations';
            } else {
                roleInfo.innerHTML = '<strong>Reception:</strong> Password: <code>reception123</code> - Access to transactions, daily roster, basic reporting<br><strong>Manager:</strong> Password: <code>manager456</code> - All reception features + staff management, advanced settings';
            }
        });
    </script>
</body>
</html>
