<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Reports - Massage Shop POS</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .admin-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .admin-nav .btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            color: #495057;
        }
        
        .admin-nav .btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .summary-card .label {
            color: #6c757d;
            font-size: 14px;
        }
        
        .filter-controls {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .filter-controls h3 {
            margin: 0 0 15px 0;
            color: #495057;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .time-period-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .time-period-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .time-period-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: #f8f9fa;
        }
        
        .time-period-tab:hover {
            background: #f8f9fa;
            color: #007bff;
        }
        
        .reports-container {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .reports-container h3 {
            margin: 0 0 15px 0;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .report-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .report-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .report-item:last-child {
            border-bottom: none;
        }
        
        .report-item .label {
            color: #6c757d;
            font-size: 14px;
        }
        
        .report-item .value {
            font-weight: bold;
            color: #495057;
        }
        
        .report-item .value.positive {
            color: #28a745;
        }
        
        .report-item .value.negative {
            color: #dc3545;
        }
        
        .chart-container {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-placeholder {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .chart-placeholder h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .export-controls {
            text-align: center;
            margin-top: 20px;
        }
        
        .export-controls .btn {
            margin: 0 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Admin Header -->
        <div class="admin-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin: 0; margin-bottom: 5px;">üìä Financial Reports & Analytics</h1>
                    <p style="margin: 0; opacity: 0.9;">View financial breakdowns and performance metrics (Manager Only)</p>
                </div>
                <div class="user-info" id="user-info" style="display: flex; align-items: center; gap: 10px;">
                    <span id="current-user" style="color: rgba(255,255,255,0.9); font-size: 14px;"></span>
                    <button onclick="logout()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">üëã Logout</button>
                </div>
            </div>
        </div>

        <!-- Admin Navigation -->
        <div class="admin-nav">
            <button class="btn" onclick="window.location.href='admin-staff.html'">üë• Staff Management</button>
            <button class="btn" onclick="window.location.href='admin-services.html'">üí∞ Services & Pricing</button>
            <button class="btn active">üìä Financial Reports</button>
            <button class="btn" onclick="window.location.href='index.html'">üè† Back to Dashboard</button>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="value" id="total-revenue">-</div>
                <div class="label">Total Revenue</div>
            </div>
            <div class="summary-card">
                <div class="value" id="total-transactions">-</div>
                <div class="label">Total Transactions</div>
            </div>
            <div class="summary-card">
                <div class="value" id="avg-transaction">-</div>
                <div class="label">Average Transaction</div>
            </div>
            <div class="summary-card">
                <div class="value" id="total-fees">-</div>
                <div class="label">Total Masseuse Fees</div>
            </div>
            <div class="summary-card">
                <div class="value" id="net-profit">-</div>
                <div class="label">Net Profit</div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <h3>üîç Filter & Date Range</h3>
            <div class="filter-row">
                <div class="form-group">
                    <label for="date-from">From Date:</label>
                    <input type="date" id="date-from" onchange="loadReports()">
                </div>
                <div class="form-group">
                    <label for="date-to">To Date:</label>
                    <input type="date" id="date-to" onchange="loadReports()">
                </div>
                <div class="form-group">
                    <label for="filter-staff">Staff Member:</label>
                    <select id="filter-staff" onchange="loadReports()">
                        <option value="">All Staff</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-service">Service Type:</label>
                    <select id="filter-service" onchange="loadReports()">
                        <option value="">All Services</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-location">Location:</label>
                    <select id="filter-location" onchange="loadReports()">
                        <option value="">All Locations</option>
                        <option value="In-Shop">In-Shop</option>
                        <option value="Home Service">Home Service</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Time Period Tabs -->
        <div class="time-period-tabs">
            <button class="time-period-tab active" onclick="setTimePeriod('today')">Today</button>
            <button class="time-period-tab" onclick="setTimePeriod('week')">This Week</button>
            <button class="time-period-tab" onclick="setTimePeriod('month')">This Month</button>
            <button class="time-period-tab" onclick="setTimePeriod('year')">This Year</button>
            <button class="time-period-tab" onclick="setTimePeriod('custom')">Custom Range</button>
        </div>

        <!-- Reports Container -->
        <div id="reports-container">
            <div class="loading">Select a date range to view financial reports</div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="loading" style="display: none;">
            Loading financial reports...
        </div>
        
        <!-- Financial Summary Container -->
        <div id="financial-summary" style="display: none;">
            <!-- Will be populated by JavaScript -->
        </div>
        
        <!-- Reports Table Container -->
        <div id="reports-table" style="display: none;">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Export Controls -->
        <div class="export-controls">
            <button class="btn" onclick="exportReport('csv')">üìä Export to CSV</button>
            <button class="btn" onclick="exportReport('pdf')">üìÑ Export to PDF</button>
            <button class="btn" onclick="printReport()">üñ®Ô∏è Print Report</button>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="shared.js"></script>
    <script>
        let currentTimePeriod = 'today';
        let currentReports = null;

        // Check authentication
        function checkAuth() {
            // For now, just ensure the page loads
            // In a real implementation, this would check if user is logged in and has manager role
            console.log('Auth check passed - loading admin reports page');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initializeFilters();
            // Don't call setTimePeriod immediately - let user choose
        });

        // Initialize filter dropdowns
        async function initializeFilters() {
            try {
                // Load staff members
                const staffResponse = await fetch('http://109.123.238.197/api/reports/staff');
                if (staffResponse.ok) {
                    const staff = await staffResponse.json();
                    const staffSelect = document.getElementById('filter-staff');
                    staff.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member; // Backend returns strings, not objects
                        option.textContent = member;
                        staffSelect.appendChild(option);
                    });
                }

                // Load service types
                const servicesResponse = await fetch('http://109.123.238.197/api/services');
                if (servicesResponse.ok) {
                    const services = await servicesResponse.json();
                    const serviceSelect = document.getElementById('filter-service');
                    const serviceTypes = [...new Set(services.map(s => s.service_name))];
                    serviceTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        serviceSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error initializing filters:', error);
            }
        }

        // Set time period and load reports
        function setTimePeriod(period) {
            let currentTimePeriod = period;
            
            // Update active tab
            document.querySelectorAll('.time-period-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Set date range based on period
            const today = new Date();
            let fromDate, toDate;
            
            switch (period) {
                case 'today':
                    fromDate = today;
                    toDate = today;
                    break;
                case 'week':
                    fromDate = new Date(today.getTime() - (today.getDay() * 24 * 60 * 60 * 1000));
                    toDate = today;
                    break;
                case 'month':
                    fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    toDate = today;
                    break;
                case 'year':
                    fromDate = new Date(today.getFullYear(), 0, 1);
                    toDate = today;
                    break;
                case 'custom':
                    // Keep current custom dates
                    return;
            }
            
            document.getElementById('date-from').value = fromDate.toISOString().split('T')[0];
            document.getElementById('date-to').value = toDate.toISOString().split('T')[0];
            
            // Add a small delay to ensure DOM is ready, then load reports
            setTimeout(() => {
                loadReports();
            }, 100);
        }

        // Load financial reports
        async function loadReports() {
            console.log('üöÄ loadReports() called');
            
            const fromDate = document.getElementById('date-from').value;
            const toDate = document.getElementById('date-to').value;
            const staffId = document.getElementById('filter-staff').value;
            const serviceType = document.getElementById('filter-service').value;
            const location = document.getElementById('filter-location').value;

            console.log('üìÖ Date values:', { fromDate, toDate, staffId, serviceType, location });

            if (!fromDate || !toDate) {
                console.log('‚ùå Missing dates, returning early');
                showToast('Please select both start and end dates', 'error');
                return;
            }

            try {
                console.log('üîÑ Starting API call...');
                
                // Show loading
                document.getElementById('loading-indicator').style.display = 'block';
                document.getElementById('reports-container').style.display = 'none';
                document.getElementById('financial-summary').style.display = 'none';
                document.getElementById('reports-table').style.display = 'none';

                // Build query parameters
                const params = new URLSearchParams({
                    from_date: fromDate,
                    to_date: toDate
                });
                
                if (staffId && staffId !== 'all') params.append('staff_member', staffId);
                if (serviceType && serviceType !== 'all') params.append('service_type', serviceType);
                if (location && location !== 'all') params.append('location', location);

                console.log('üì° API URL:', `/api/reports/financial?${params}`);
                const response = await fetch(`http://109.123.238.197/api/reports/financial?${params}`);
                console.log('üì• Response status:', response.status, response.statusText);
                
                if (response.ok) {
                    currentReports = await response.json();
                    console.log('‚úÖ API response received:', currentReports);
                    displayReports();
                } else {
                    console.log('‚ùå API response not OK');
                    throw new Error('Failed to load reports');
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                document.getElementById('reports-container').innerHTML = `
                    <div class="reports-container">
                        <h3>‚ùå Error Loading Reports</h3>
                        <p>Failed to load financial reports. Please try again.</p>
                        <button class="btn" onclick="loadReports()">üîÑ Retry</button>
                    </div>
                `;
            }
        }

        // Format date range for display
        function formatDateRange(dateRange) {
            if (!dateRange || !dateRange.from || !dateRange.to) return 'Custom Range';
            
            const fromDate = new Date(dateRange.from);
            const toDate = new Date(dateRange.to);
            
            if (dateRange.from === dateRange.to) {
                return fromDate.toLocaleDateString();
            } else {
                return `${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()}`;
            }
        }

        // Display financial reports
        function displayReports() {
            console.log('üé® displayReports() called');
            
            if (!currentReports) {
                console.log('‚ùå No currentReports data, returning');
                return;
            }

            if (!currentReports.summary) {
                console.log('‚ùå No summary data in currentReports, returning');
                return;
            }

            console.log('üìä Processing reports data...');
            
            // Hide loading indicator
            document.getElementById('loading-indicator').style.display = 'none';
            
            // Update summary cards with safe data access
            const summary = currentReports.summary;
            document.getElementById('total-revenue').textContent = `‡∏ø${(summary.total_revenue || 0).toFixed(0)}`;
            document.getElementById('total-transactions').textContent = summary.total_transactions || 0;
            document.getElementById('avg-transaction').textContent = `‡∏ø${(summary.average_transaction || 0).toFixed(0)}`;
            document.getElementById('total-fees').textContent = `‡∏ø${(summary.total_masseuse_fees || 0).toFixed(0)}`;
            document.getElementById('net-profit').textContent = `‡∏ø${(summary.net_profit || 0).toFixed(0)}`;

            // Build reports HTML
            let reportsHTML = `
                <div class="reports-container">
                    <h3>üìä Financial Summary (${formatDateRange(currentReports.dateRange)})</h3>
                    
                    <div class="report-grid">
                        <div class="report-section">
                            <h4>üí∞ Revenue Breakdown</h4>
                            <div class="report-item">
                                <span class="label">Total Revenue:</span>
                                <span class="value positive">‡∏ø${(currentReports.summary.total_revenue || 0).toFixed(0)}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Service Revenue:</span>
                                <span class="value">‡∏ø${(currentReports.summary.serviceRevenue || 0).toFixed(0)}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Other Revenue:</span>
                                <span class="value">‡∏ø${(currentReports.summary.otherRevenue || 0).toFixed(0)}</span>
                            </div>
                        </div>
                        
                        <div class="report-section">
                            <h4>üí∏ Cost Breakdown</h4>
                            <div class="report-item">
                                <span class="label">Total Masseuse Fees:</span>
                                <span class="value negative">‡∏ø${(currentReports.summary.totalFees || 0).toFixed(0)}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Other Costs:</span>
                                <span class="value negative">‡∏ø${(currentReports.summary.otherCosts || 0).toFixed(0)}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Total Costs:</span>
                                <span class="value negative">‡∏ø${(currentReports.summary.totalCosts || 0).toFixed(0)}</span>
                            </div>
                        </div>
                        
                        <div class="report-section">
                            <h4>üìà Performance Metrics</h4>
                            <div class="report-item">
                                <span class="label">Net Profit:</span>
                                <span class="value ${(currentReports.summary.net_profit || 0) >= 0 ? 'positive' : 'negative'}">‡∏ø${(currentReports.summary.net_profit || 0).toFixed(0)}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Profit Margin:</span>
                                <span class="value">${(currentReports.summary.profit_margin || 0).toFixed(1)}%</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Transactions:</span>
                                <span class="value">${currentReports.summary.total_transactions || 0}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add payment type breakdown section - NEW FEATURE
            if (currentReports.breakdowns && currentReports.breakdowns.by_payment_method && currentReports.breakdowns.by_payment_method.length > 0) {
                reportsHTML += `
                    <div class="reports-container">
                        <h3>üí≥ Payment Type Breakdown - Account Verification</h3>
                        <p style="color: #6c757d; margin-bottom: 15px; font-style: italic;">Verify your accounts by checking the expected amounts below:</p>
                        <div class="report-grid">
                `;
                
                currentReports.breakdowns.by_payment_method.forEach(paymentType => {
                    reportsHTML += `
                        <div class="report-section">
                            <h4>${paymentType.payment_method}</h4>
                            <div class="report-item">
                                <span class="label">Revenue:</span>
                                <span class="value positive">‡∏ø${(paymentType.revenue || 0).toFixed(0)}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Transactions:</span>
                                <span class="value">${paymentType.count || 0}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Percentage:</span>
                                <span class="value">${currentReports.summary.total_revenue > 0 ? ((paymentType.revenue / currentReports.summary.total_revenue) * 100).toFixed(1) : '0'}%</span>
                            </div>
                        </div>
                    `;
                });
                
                reportsHTML += `
                        </div>
                    </div>
                `;
            }

            // Add service breakdown if available
            if (currentReports.serviceBreakdown && currentReports.serviceBreakdown.length > 0) {
                reportsHTML += `
                    <div class="reports-container">
                        <h3>üîß Service Performance</h3>
                        <div class="report-grid">
                `;
                
                currentReports.serviceBreakdown.forEach(service => {
                    reportsHTML += `
                        <div class="report-section">
                            <h4>${service.serviceName}</h4>
                            <div class="report-item">
                                <span class="label">Revenue:</span>
                                <span class="value positive">‡∏ø${(service.revenue || 0).toFixed(0)}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Transactions:</span>
                                <span class="value">${service.transactions || 0}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Avg. Price:</span>
                                <span class="value">‡∏ø${service.transactions && service.revenue ? ((service.revenue / service.transactions) || 0).toFixed(0) : '0'}</span>
                            </div>
                        </div>
                    `;
                });
                
                reportsHTML += `
                        </div>
                    </div>
                `;
            }

            // Add staff performance if available
            if (currentReports.staffBreakdown && currentReports.staffBreakdown.length > 0) {
                reportsHTML += `
                    <div class="reports-container">
                        <h3>üë• Staff Performance</h3>
                        <div class="report-grid">
                `;
                
                currentReports.staffBreakdown.forEach(staff => {
                    reportsHTML += `
                        <div class="report-section">
                            <h4>${staff.staffName}</h4>
                            <div class="report-item">
                                <span class="label">Services:</span>
                                <span class="value">${staff.services || 0}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Fees Earned:</span>
                                <span class="value positive">‡∏ø${(staff.feesEarned || 0).toFixed(0)}</span>
                            </div>
                            <div class="report-item">
                                <span class="label">Avg. Rating:</span>
                                <span class="value">${staff.averageRating ? (staff.averageRating || 0).toFixed(1) + '‚≠ê' : 'N/A'}</span>
                            </div>
                        </div>
                    `;
                });
                
                reportsHTML += `
                        </div>
                    </div>
                `;
            }

            // Add chart placeholders
            reportsHTML += `
                <div class="chart-container">
                    <h3>üìà Revenue Trends</h3>
                    <div class="chart-placeholder">
                        <h4>üìä Chart Visualization</h4>
                        <p>Interactive charts and graphs will be implemented in future versions.</p>
                        <p>Currently showing data for: ${formatDateRange(currentReports.dateRange)}</p>
                    </div>
                </div>
            `;

            // Display the reports
            document.getElementById('reports-container').innerHTML = reportsHTML;
            document.getElementById('reports-container').style.display = 'block';
        }

        // Export report functions
        function exportReport(format) {
            if (!currentReports) {
                showToast('No reports to export. Please load reports first.', 'error');
                return;
            }
            
            if (format === 'csv') {
                exportToCSV();
            } else if (format === 'pdf') {
                exportToPDF();
            }
        }

        function exportToCSV() {
            // Implementation for CSV export
            showToast('CSV export functionality will be implemented in future versions.', 'info');
        }

        function exportToPDF() {
            // Implementation for PDF export
            showToast('PDF export functionality will be implemented in future versions.', 'info');
        }

        function printReport() {
            if (!currentReports) {
                showToast('No reports to print. Please load reports first.', 'error');
                return;
            }
            
            window.print();
        }

        // Set default date range to today
        function setDefaultDates() {
            const today = new Date();
            document.getElementById('date-from').value = today.toISOString().split('T')[0];
            document.getElementById('date-to').value = today.toISOString().split('T')[0];
        }

        // Initialize default dates
        setDefaultDates();
    </script>
</body>
</html>
