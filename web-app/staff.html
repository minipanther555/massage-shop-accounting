<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Massage Shop POS - Staff Roster</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="nav-header">
            STAFF ROSTER MANAGEMENT
        </div>

        <div class="nav-buttons">
            <a href="index.html" class="nav-btn home">üè† Home</a>
            <a href="staff.html" class="nav-btn staff active">üë• Staff Roster</a>
            <a href="transaction.html" class="nav-btn transaction">üí≥ New Transaction</a>
            <a href="summary.html" class="nav-btn summary">üìä Daily Summary</a>
        </div>

        <!-- Serve Next Button -->
        <div class="section">
            <div class="section-header">
                QUICK ACTIONS
                <button class="btn btn-next" onclick="handleServeNext()">
                    üë§ Serve Next Customer
                </button>
            </div>
        </div>

        <!-- Add Staff Section -->
        <div class="section">
            <div class="section-header">ADD STAFF FOR TODAY</div>
            <div class="section-content">
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <select id="available-staff" style="flex: 1;">
                        <option value="">Select masseuse to add...</option>
                    </select>
                    <button onclick="addStaffToRoster()" class="btn">Add to Roster</button>
                    <button onclick="clearTodayRoster()" class="btn btn-secondary">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Today's Staff Roster -->
        <div class="section">
            <div class="section-header">TODAY'S STAFF ROSTER</div>
            <div class="section-content">
                <div class="roster-grid">
                    <div><strong>Position</strong></div>
                    <div><strong>Masseuse Name</strong></div>
                    <div><strong>Next in Line</strong></div>
                    <div><strong>Today's Count</strong></div>
                    <div><strong>Actions</strong></div>
                </div>
                <div id="roster-list">
                    <!-- Today's roster items will be populated by JavaScript -->
                </div>
                <div id="empty-roster" style="text-align: center; padding: 20px; color: #666; display: none;">
                    No staff added for today. Use the dropdown above to add masseuses to today's roster.
                </div>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            await loadData(); // Load data from API first
            updateAvailableStaffDropdown(); // Populate the dropdown
            updateRosterDisplay(); // Then display the roster
            setInterval(async () => {
                await loadData();
                updateAvailableStaffDropdown();
                updateRosterDisplay();
            }, 30000);
        });

        // Today's working roster (subset of full roster)
        let todayRoster = [];

        function updateAvailableStaffDropdown() {
            const dropdown = document.getElementById('available-staff');
            dropdown.innerHTML = '<option value="">Select masseuse to add...</option>';
            
            // Get masseuses not already in today's roster
            const usedNames = todayRoster.map(staff => staff.name);
            const availableStaff = CONFIG.settings.masseuses.filter(name => !usedNames.includes(name));
            
            availableStaff.forEach(name => {
                dropdown.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }

        function updateRosterDisplay() {
            const rosterList = document.getElementById('roster-list');
            const emptyMessage = document.getElementById('empty-roster');
            
            if (todayRoster.length === 0) {
                rosterList.innerHTML = '';
                emptyMessage.style.display = 'block';
                return;
            }
            
            emptyMessage.style.display = 'none';
            rosterList.innerHTML = '';

            todayRoster.forEach((staff, index) => {
                const div = document.createElement('div');
                div.className = 'roster-grid';
                div.innerHTML = `
                    <div>#${index + 1}</div>
                    <div><strong>${staff.name}</strong></div>
                    <div>
                        <button onclick="setNextInLine(${index})" 
                                class="btn ${staff.isNext ? 'btn-next' : 'btn-secondary'}" 
                                style="font-size: 12px; padding: 5px 10px;">
                            ${staff.isNext ? 'üë§ NEXT' : 'Set Next'}
                        </button>
                    </div>
                    <div><strong>${staff.todayCount}</strong></div>
                    <div>
                        <button onclick="moveUp(${index})" class="btn btn-small" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button onclick="moveDown(${index})" class="btn btn-small" ${index === todayRoster.length - 1 ? 'disabled' : ''}>‚Üì</button>
                        <button onclick="removeFromRoster(${index})" class="btn btn-danger btn-small">‚úï</button>
                    </div>
                `;
                rosterList.appendChild(div);
            });
            
            updateAvailableStaffDropdown();
        }

        function addStaffToRoster() {
            const dropdown = document.getElementById('available-staff');
            const selectedName = dropdown.value;
            
            if (!selectedName) {
                showToast('Please select a masseuse to add', 'error');
                return;
            }
            
            // Find the staff member from the full roster data
            const staffData = appData.roster.find(r => r.name === selectedName);
            const todayCount = staffData ? staffData.todayCount : 0;
            
            todayRoster.push({
                name: selectedName,
                isNext: todayRoster.length === 0, // First person is automatically next
                todayCount: todayCount
            });
            
            updateRosterDisplay();
            showToast(`Added ${selectedName} to today's roster`);
        }

        function removeFromRoster(index) {
            const removedStaff = todayRoster[index];
            todayRoster.splice(index, 1);
            
            // If removed person was "next", set first person as next
            if (removedStaff.isNext && todayRoster.length > 0) {
                todayRoster[0].isNext = true;
            }
            
            updateRosterDisplay();
            showToast(`Removed ${removedStaff.name} from today's roster`);
        }

        function setNextInLine(index) {
            // Clear all "next" flags
            todayRoster.forEach(staff => staff.isNext = false);
            // Set selected person as next
            todayRoster[index].isNext = true;
            updateRosterDisplay();
            showToast(`${todayRoster[index].name} is now next in line`);
        }

        function moveUp(index) {
            if (index > 0) {
                [todayRoster[index], todayRoster[index - 1]] = [todayRoster[index - 1], todayRoster[index]];
                updateRosterDisplay();
                showToast(`Moved ${todayRoster[index - 1].name} up in queue`);
            }
        }

        function moveDown(index) {
            if (index < todayRoster.length - 1) {
                [todayRoster[index], todayRoster[index + 1]] = [todayRoster[index + 1], todayRoster[index]];
                updateRosterDisplay();
                showToast(`Moved ${todayRoster[index + 1].name} down in queue`);
            }
        }

        function clearTodayRoster() {
            if (confirm('Clear all staff from today\'s roster?')) {
                todayRoster = [];
                updateRosterDisplay();
                showToast('Today\'s roster cleared');
            }
        }

        function handleServeNext() {
            const nextMasseuse = serveNextCustomer();
            if (nextMasseuse) {
                updateRosterDisplay();
                setTimeout(() => {
                    window.location.href = `transaction.html?masseuse=${encodeURIComponent(nextMasseuse)}`;
                }, 1000);
            }
        }
    </script>
</body>
</html>
